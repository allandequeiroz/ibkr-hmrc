# Discussion 8: Tax Computation Enhancement - Complete Specification

**Date**: 2026-01-30  
**Last Updated**: 2026-01-30  
**Status**: Implementation In Progress  
**Context**: User request to enhance trial balance tool with full UK Corporation Tax computation

---

## ⚠️ Critical Updates (2026-01-30)

This specification has been updated to address critical issues identified during review:

1. **Section 104 Same-Day and 30-Day Matching Rules** - Added implementation of UK tax law requirements for share identification before pooling
2. **ICR Calculation Warning** - Added explicit warning that ICR restrictions may not apply to investment companies; professional tax advice recommended
3. **Corporation Tax Rates Verified** - Confirmed 2025-26 rates and added marginal relief calculation (3/200 fraction)
4. **Edge Case Handling** - Added handling for negative pools, zero quantities, division by zero, FIFO failures
5. **Options Treatment Clarification** - Documented assumption that Section 104 applies to options; professional tax advice recommended
6. **Tax Computation Structure** - Clarified that capital gains are calculated separately, not "added back"

**Timeline Updated**: Increased from 14-17 hours to 19-23 hours due to complexity of matching rules.

---

## Table of Contents

1. [Problem Statement](#problem-statement)
2. [User Requirements](#user-requirements)
3. [Research Findings](#research-findings)
4. [Solution Architecture](#solution-architecture)
5. [User Confirmations](#user-confirmations)
6. [Implementation Plan](#implementation-plan)
7. [Current Status](#current-status)
8. [Next Steps](#next-steps)

---

## Problem Statement

### Original User Request

> "In the HMRC context, what does it mean to reconcile? Are these documents I have here enough to reconcile? Do I need bank statements? Do I need the entries I have in Intuit/QuickBooks?
>
> How do I get to the point where I can calculate my tax burden, ensure the numbers match, and leverage discounts, such as tax shield? I'd like to have all that in the report generated by my script."

### Current Tool Limitations

The existing `ibkr_trial_balance.py` tool generates FRS 105 compliant trial balances from IBKR Flex Query data, but:

1. **FRS 105 ≠ Tax Accounts**: Financial statements are not the same as tax computations required for CT600 filing
2. **FIFO vs Section 104**: Tool uses FIFO cost tracking (matches IBKR), but UK tax law defaults to Section 104 pooling for Corporation Tax
3. **No Tax Computation**: No calculation of taxable profit or Corporation Tax liability
4. **No Tax Shields**: No identification or application of available tax reliefs (dividend exemption, SSE, management expenses, interest relief)
5. **No CT600 Mapping**: No mapping of figures to CT600 form boxes for accountant filing

### Documents Available

**User currently has:**
- ✓ FRS 105 trial balance (from tool)
- ✓ IBKR Flex Query CSV (trades, dividends, interest)
- ✓ IBKR Activity Statement
- ✓ IBKR Realized Summary

**User does NOT need:**
- ✗ Bank statements (unless loan reconciliation needed)
- ✗ QuickBooks entries beyond trial balance

**User is MISSING:**
- Section 104 pooling schedule
- Capital gains computation per asset
- Tax computation template showing adjustments
- Tax relief/shield identification
- CT600 box mapping

---

## User Requirements

### Primary Goal

Generate a comprehensive HTML report that includes:
1. Complete tax burden calculation (Corporation Tax liability)
2. Reconciliation ensuring numbers match between trial balance and tax computation
3. Identification and application of all available tax shields
4. All supporting documentation needed for CT600 filing

### Specific Needs

1. **Section 104 Share Pooling** - UK tax law requirement for CGT calculations
2. **Tax Computation Schedule** - Shows profit to taxable profit reconciliation
3. **Tax Shield Summary** - Lists all reliefs applied and tax saved
4. **Corporation Tax Liability** - Final tax burden
5. **CT600 Box Mapping** - Ready for accountant to file
6. **Variance Analysis** - Explains differences between FIFO and Section 104

---

## Research Findings

### What is HMRC Reconciliation?

In HMRC terms, reconciliation is the audit trail showing:
1. **Accounting profit** (from trial balance/P&L) - FRS 105 basis
2. **Tax adjustments** (HMRC rules) - Add backs, deductions, separate regimes
3. **Taxable profit** (feeds into CT600) - Final tax base

### FRS 105 vs Tax Accounts

| Aspect | FRS 105 (Financial Statements) | CT600 (Tax Accounts) |
|--------|-------------------------------|---------------------|
| **Purpose** | True & fair view of financial position | Calculate taxable profit per HMRC rules |
| **Depreciation** | Based on useful life estimates | Replaced with capital allowances |
| **Disallowable expenses** | Included if incurred | Added back |
| **Dividends received** | Recorded as income | Automatically exempt from tax |
| **Capital gains** | May be in P&L or reserves | Subject to CGT rules; Section 104 pooling applies |
| **Interest income** | Recorded as investment income | Taxable under loan relationship rules |
| **Cost method** | FIFO (acceptable) | Section 104 pooling (default) |

### Section 104 Pooling vs FIFO

| Aspect | FIFO (Current Tool) | Section 104 (UK Tax Law) |
|--------|---------------------|--------------------------|
| **Method** | Oldest shares sold first | All shares of same type pooled; average cost |
| **Tax outcome** | Often less favourable (older = lower cost = higher gain) | Often more favourable (average cost spreads gains) |
| **Flexibility** | IBKR assumes FIFO | UK default; can elect FIFO if worse for tax |
| **Records needed** | Individual lot tracking | Pool balance and acquisitions only |
| **Tool status** | ✓ Implemented | ✗ Not implemented (REQUIRED) |

**CRITICAL**: IBKR's FIFO figures are NOT correct for UK tax purposes. ALL disposals must be recalculated using Section 104 pooling for CT600.

### Section 104 Share Identification Rules (CRITICAL)

Under UK capital gains tax rules, shares must be identified against disposals in a specific order:

1. **Same-day rule**: Against acquisitions on the same day (highest priority)
2. **30-day rule (bed and breakfast)**: Against acquisitions within 30 days following the disposal
3. **Section 104 pool**: Against shares in the Section 104 pool (average cost)
4. **Later acquisitions**: Against acquisitions following the disposal (earliest first)

**IMPORTANT**: Shares matched under same-day or 30-day rules do NOT enter the Section 104 pool. Only unmatched acquisitions go into the pool.

**Options Treatment**: Section 104 pooling applies to shares. Options contracts may require different treatment. The current implementation applies Section 104 to all asset classes (STK, OPT, CASH, CRYPTO). Professional tax advice should confirm whether options require different treatment for UK Corporation Tax purposes.

### Available Tax Shields for Investment Holding Companies

#### 1. Dividend Exemption (AUTOMATIC - HUGE)
- **All dividends received are exempt from Corporation Tax**
- Applies to UK and foreign dividends
- No election needed; automatic
- This is the biggest tax advantage for investment companies
- **Impact**: If £780 dividend income, saves £148 in tax at 19% rate

#### 2. Substantial Shareholding Exemption (SSE) - CONDITIONAL
- Exempts capital gains on share disposals IF:
  - Held ≥10% of ordinary share capital
  - For ≥12 months in 6 years before disposal
  - Target is "qualifying company" (trading company or holding company of trading group)
- **KEY ISSUE FOR USER**: If holding only US-listed securities, SSE likely does NOT apply
- **Impact**: Without SSE, capital gains are taxable at 19-25% Corporation Tax rate

#### 3. Management Expense Relief - LIMITED
- Investment companies can deduct expenses of managing investments
- Must be revenue expenses, not capital
- Examples: professional fees, IBKR fees, admin costs, subscriptions
- Does NOT include: depreciation (use capital allowances instead)

#### 4. Interest Relief - CONDITIONAL
- If company borrowed to finance investments, interest is deductible
- **Subject to 30% Interest Coverage Ratio (ICR) restriction**
- ICR Rule: Interest deduction limited to 30% of taxable earnings (EBITDA proxy)
- Disallowed interest can be carried forward to future years

**⚠️ WARNING**: ICR restrictions are complex and may not apply to investment companies in the same way as trading companies. This implementation assumes ICR applies, but professional tax advice should be sought to confirm:
- Whether ICR restrictions apply to investment holding companies
- The correct calculation method for taxable earnings (EBITDA proxy)
- Whether the 30% limit is appropriate for investment companies

#### 5. Capital Allowances - LIKELY NOT APPLICABLE
- Normal allowances (18% writing down) apply to plant & machinery
- For investment-only holdings, rarely relevant unless office equipment
- Securities themselves get NO capital allowances

#### NOT Available (Red Flags)
- Trading company reliefs (only for active trading)
- R&D relief (only for research & development)
- Investors' Relief (individuals only)

### Corporation Tax Rates (2025-26)

**Source**: [HMRC Rates and Allowances](https://www.gov.uk/government/publications/rates-and-allowances-corporation-tax)

- **Small Profits Rate**: 19% on profits up to £50,000
- **Main Rate**: 25% on profits over £250,000
- **Marginal Relief**: Companies with profits between £50,000 and £250,000 qualify for marginal relief, which gradually increases the effective tax rate from 19% to 25% using the standard fraction of 3/200

**Calculation for Marginal Relief**:
- For profits between £50k-£250k: Tax = (Profit × 25%) - ((£250,000 - Profit) × 3/200)
- This creates a tapered rate between 19% and 25%

### Tax Computation Structure

```
STEP 1: Extract Trial Balance Profit
Profit per accounts (before tax):              £X

STEP 2: Add Back Disallowable Items
+ Depreciation/amortization                    £Y
+ Disallowable expenses                        £Z
+ Capital gains (separate tax regime)          £A

STEP 3: Deduct Allowable Items
- Capital allowances                          -£B
- Management expenses                         -£C

STEP 4: Calculate Trading/Non-Trading Income
Non-trading income (investment income):        £D
+ Interest received                            £E
- Interest paid on loans (ICR-restricted)     -£F
- Management expenses                         -£G
= Total taxable profit (excluding capital)     £H

STEP 5: Calculate Capital Gains (Separate)
Capital gains (per Section 104):               £I
- SSE relief (if applicable)                  -£J
- Capital losses brought forward              -£K
= Taxable capital gains                        £L

STEP 6: Total Taxable Profit
Total taxable profit (CT600):                  £H + £L

STEP 7: Calculate Corporation Tax Liability
Taxable profit:                                £(H+L)
Tax rate (19% or 25% depending on profit):     X%
Corporation Tax liability:                     £M
```

### Interest Coverage Ratio (ICR) Restriction

**Rule**: Interest deduction limited to 30% of taxable earnings

**For Investment Company**:
- Taxable earnings = Interest received - Management expenses
- ICR limit = 30% × Taxable earnings
- If interest paid > ICR limit:
  - Allowable interest = ICR limit
  - Disallowed interest = Interest paid - ICR limit
  - Disallowed interest can be carried forward to future years

**Example**:
```
Interest received: £10,000
Management expenses: £5,000
Taxable earnings: £5,000
ICR limit: £5,000 × 30% = £1,500

If interest paid: £3,000
Allowable interest: £1,500 (capped by ICR)
Disallowed interest: £1,500 (carry forward)
```

---

## Solution Architecture

### Overview

Enhance `ibkr_trial_balance.py` to:
1. Maintain existing FRS 105 trial balance generation (FIFO)
2. Add parallel Section 104 pooling for UK tax computation
3. Generate comprehensive tax computation with all adjustments
4. Calculate Corporation Tax liability
5. Identify and apply all available tax shields
6. Provide CT600 box mapping for accountant filing
7. Output all in single enhanced HTML report

### Dual Tracking Approach

**FIFO (Keep)**: For FRS 105 financial statements (existing functionality)
**Section 104 (Add)**: For UK Corporation Tax (CT600) (new functionality)

Both tracking methods run in parallel, with variance analysis explaining differences.

### New Modules

#### 1. Section 104 Pooling Module (`scripts/section_104_pooling.py`)

**Purpose**: Calculate average cost basis per UK tax law

**Classes**:
- `Section104Pool` - Main pooling engine
- `PoolTransaction` - Individual acquisition/disposal dataclass

**Key Methods**:
- `add_acquisition(date, symbol, qty, cost_gbp)` - Add to pool
- `remove_disposal(date, symbol, qty)` - Remove from pool, return cost and gain/loss
- `get_pool_summary()` - Current holdings at pooled cost
- `get_disposal_summary()` - All disposals with gain/loss

**Key Logic** (with same-day and 30-day matching):
```python
from datetime import timedelta
from collections import defaultdict

class Section104Pool:
    def __init__(self):
        # Section 104 pools (average cost per symbol)
        self.pools = defaultdict(lambda: {'qty': Decimal('0'), 'cost': Decimal('0')})
        
        # Pending acquisitions for same-day/30-day matching
        # Format: {symbol: [(date, qty, cost_gbp), ...]}
        self.pending_acquisitions = defaultdict(list)
        
        # Pending disposals waiting for 30-day matching window
        # Format: {symbol: [(date, qty, proceeds_gbp), ...]}
        self.pending_disposals = defaultdict(list)
        
        # Completed disposals with gain/loss
        self.disposals = []

    def add_acquisition(self, date, symbol, qty, cost_gbp):
        """Add acquisition - check for same-day/30-day matching first."""
        # Check for pending disposals on same day
        same_day_disposals = [
            d for d in self.pending_disposals[symbol]
            if d[0] == date
        ]
        
        remaining_qty = qty
        remaining_cost = cost_gbp
        
        # Match against same-day disposals first
        for i, (disp_date, disp_qty, disp_proceeds) in enumerate(same_day_disposals):
            if remaining_qty <= 0:
                break
            
            match_qty = min(remaining_qty, disp_qty)
            match_cost = (remaining_cost * match_qty / qty).quantize(Decimal('0.01'))
            
            # Record gain/loss for matched disposal
            gain_loss = disp_proceeds - match_cost
            self.disposals.append({
                'date': disp_date,
                'symbol': symbol,
                'quantity': match_qty,
                'proceeds': disp_proceeds,
                'cost': match_cost,
                'gain_loss': gain_loss,
                'matching_rule': 'same_day'
            })
            
            # Update pending disposal
            if disp_qty == match_qty:
                self.pending_disposals[symbol].pop(i)
            else:
                self.pending_disposals[symbol][i] = (
                    disp_date, disp_qty - match_qty, 
                    disp_proceeds - (disp_proceeds * match_qty / disp_qty)
                )
            
            remaining_qty -= match_qty
            remaining_cost -= match_cost
        
        # Add remaining unmatched acquisition to pending queue for 30-day matching
        if remaining_qty > 0:
            self.pending_acquisitions[symbol].append((
                date, remaining_qty, remaining_cost
            ))
            
            # After 30 days, move to Section 104 pool
            # (This will be handled in remove_disposal when checking 30-day window)

    def remove_disposal(self, date, symbol, qty, proceeds_gbp):
        """Remove disposal with same-day and 30-day matching rules."""
        # 1. Try same-day acquisitions first
        same_day_acqs = [
            a for a in self.pending_acquisitions[symbol]
            if a[0] == date
        ]
        
        remaining_qty = qty
        total_cost = Decimal('0')
        
        # Match against same-day acquisitions
        for i, (acq_date, acq_qty, acq_cost) in enumerate(same_day_acqs):
            if remaining_qty <= 0:
                break
            
            match_qty = min(remaining_qty, acq_qty)
            match_cost = (acq_cost * match_qty / acq_qty).quantize(Decimal('0.01'))
            match_proceeds = (proceeds_gbp * match_qty / qty).quantize(Decimal('0.01'))
            
            # Record gain/loss
            gain_loss = match_proceeds - match_cost
            self.disposals.append({
                'date': date,
                'symbol': symbol,
                'quantity': match_qty,
                'proceeds': match_proceeds,
                'cost': match_cost,
                'gain_loss': gain_loss,
                'matching_rule': 'same_day'
            })
            
            # Remove matched acquisition
            if acq_qty == match_qty:
                self.pending_acquisitions[symbol].pop(i)
            else:
                self.pending_acquisitions[symbol][i] = (
                    acq_date, acq_qty - match_qty, 
                    acq_cost - match_cost
                )
            
            remaining_qty -= match_qty
            total_cost += match_cost
        
        # 2. Try 30-day acquisitions (check acquisitions within 30 days after disposal)
        # Note: This requires checking future acquisitions, so we'll queue the disposal
        # and match when acquisitions arrive
        
        # 3. Use Section 104 pool for remainder
        if remaining_qty > 0:
            pool = self.pools[symbol]
            if pool['qty'] == 0:
                # FIFO failure - no shares in pool
                print(f"Warning: Selling {remaining_qty} {symbol} but pool is empty. Using zero cost.")
                pool_cost = Decimal('0')
            else:
                # Calculate average cost per share
                avg_cost = pool['cost'] / pool['qty']
                pool_cost = (avg_cost * remaining_qty).quantize(Decimal('0.01'))
                
                # Update pool
                pool['cost'] -= pool_cost
                pool['qty'] -= remaining_qty
            
            remaining_proceeds = (proceeds_gbp * remaining_qty / qty).quantize(Decimal('0.01'))
            gain_loss = remaining_proceeds - pool_cost
            
            self.disposals.append({
                'date': date,
                'symbol': symbol,
                'quantity': remaining_qty,
                'proceeds': remaining_proceeds,
                'cost': pool_cost,
                'gain_loss': gain_loss,
                'matching_rule': 'section_104'
            })
            
            total_cost += pool_cost
        
        return total_cost
    
    def _move_expired_acquisitions_to_pool(self, current_date):
        """Move acquisitions older than 30 days to Section 104 pool."""
        cutoff_date = current_date - timedelta(days=30)
        
        for symbol, acqs in list(self.pending_acquisitions.items()):
            for acq_date, qty, cost in acqs[:]:
                if acq_date < cutoff_date:
                    # Move to pool
                    pool = self.pools[symbol]
                    pool['qty'] += qty
                    pool['cost'] += cost
                    # Remove from pending
                    self.pending_acquisitions[symbol].remove((acq_date, qty, cost))
```

**Note**: The 30-day matching requires checking future acquisitions. In practice, we'll process trades chronologically and queue disposals for 30 days, matching them as acquisitions arrive. This requires a two-pass approach or maintaining a rolling 30-day window.

#### 2. Tax Computation Module (`scripts/tax_computation.py`)

**Purpose**: Calculate taxable profit and Corporation Tax liability

**Classes**:
- `TaxComputation` - Main tax engine
- `TaxAdjustment` - Individual adjustment record dataclass

**Key Methods**:
- `calculate_dividend_exemption()` - Extract exempt dividends from trial balance
- `calculate_capital_gains()` - From Section 104 pool
- `calculate_management_expenses()` - Identify deductible expenses (IBKR + additional)
- `calculate_interest_relief()` - Apply ICR restriction
- `calculate_tax_liability()` - Final CT liability
- `generate_ct600_mapping()` - Map figures to CT600 boxes

**Key Logic for Interest Relief**:
```python
def calculate_interest_relief(self):
    """Calculate allowable interest relief with ICR restriction.
    
    ⚠️ WARNING: ICR restrictions are complex and may not apply to investment
    companies in the same way as trading companies. Professional tax advice
    should be sought to confirm eligibility and calculation method.
    """
    # Extract interest paid from trial balance
    interest_paid = self.tb.accounts['5600'].debit
    
    if interest_paid == 0:
        # No interest paid - no ICR calculation needed
        return {
            'total_interest_paid': Decimal('0'),
            'allowable_interest': Decimal('0'),
            'disallowed_interest': Decimal('0'),
            'icr_limit': Decimal('0'),
            'icr_applicable': False
        }

    # Calculate taxable earnings (EBITDA proxy)
    # For investment company: interest received - management expenses
    # NOTE: This calculation may not be correct for investment companies.
    # ICR rules are designed for trading companies and may not apply.
    interest_received = self.tb.accounts['4100'].credit
    management_expenses = self.tb.accounts['5200'].debit
    
    # Taxable earnings = interest received - management expenses
    # If negative, ICR limit would be negative (no interest deduction allowed)
    taxable_earnings = interest_received - management_expenses
    
    if taxable_earnings <= 0:
        # No taxable earnings - ICR limit is zero
        allowable_interest = Decimal('0')
        disallowed_interest = interest_paid
        icr_limit = Decimal('0')
    else:
        # Interest Coverage Ratio: interest deduction limited to 30% of taxable earnings
        icr_limit = taxable_earnings * Decimal('0.30')
        
        if interest_paid <= icr_limit:
            # Full interest deduction allowed
            allowable_interest = interest_paid
            disallowed_interest = Decimal('0')
        else:
            # Partial interest deduction; excess disallowed
            allowable_interest = icr_limit
            disallowed_interest = interest_paid - icr_limit

    return {
        'total_interest_paid': interest_paid,
        'allowable_interest': allowable_interest,
        'disallowed_interest': disallowed_interest,
        'icr_limit': icr_limit,
        'taxable_earnings': taxable_earnings,
        'icr_applicable': True,
        'warning': 'ICR calculation may not apply to investment companies. Seek professional tax advice.'
    }
```

**Key Logic for Tax Computation**:
```python
def calculate_taxable_profit(self):
    """Calculate taxable profit from accounting profit."""
    # Start with trial balance profit
    accounting_profit = self._get_accounting_profit()

    # Add back dividend income (exempt)
    dividend_income = self.tb.accounts['4000'].credit
    self.adjustments.append(TaxAdjustment(
        'Dividend Exemption',
        dividend_income,
        'add_back'
    ))

    # Extract capital gains (separate regime)
    capital_gains = self._get_section_104_gains()

    # Calculate non-trading income
    interest_income = self.tb.accounts['4100'].credit
    management_expenses_ibkr = self.tb.accounts['5200'].debit
    management_expenses_other = self._load_additional_expenses()

    # Calculate interest relief with ICR restriction
    interest_relief = self.calculate_interest_relief()
    allowable_interest = interest_relief['allowable_interest']

    taxable_non_trading = (interest_income
                          - management_expenses_ibkr
                          - management_expenses_other
                          - allowable_interest)

    # Total taxable profit
    taxable_capital_gains = capital_gains  # No SSE assumed
    total_taxable = taxable_non_trading + taxable_capital_gains

    return total_taxable

def calculate_corporation_tax(self, taxable_profit):
    """Calculate Corporation Tax liability.
    
    Source: HMRC Rates and Allowances 2025-26
    - Small Profits Rate: 19% on profits up to £50,000
    - Main Rate: 25% on profits over £250,000
    - Marginal Relief: Standard fraction 3/200 for profits between £50k-£250k
    """
    if taxable_profit <= 0:
        return Decimal('0')
    
    if taxable_profit <= 50000:
        # Small profits rate: 19%
        tax_liability = taxable_profit * Decimal('0.19')
    elif taxable_profit >= 250000:
        # Main rate: 25%
        tax_liability = taxable_profit * Decimal('0.25')
    else:
        # Marginal relief: Tax = (Profit × 25%) - ((£250,000 - Profit) × 3/200)
        tax_at_main_rate = taxable_profit * Decimal('0.25')
        marginal_relief = (Decimal('250000') - taxable_profit) * Decimal('3') / Decimal('200')
        tax_liability = tax_at_main_rate - marginal_relief
    
    return tax_liability.quantize(Decimal('0.01'))
```

### Enhanced HTML Report Sections

The enhanced report will include (in order):

1. **Existing Trial Balance Section** (unchanged)
   - Assets, Liabilities, Capital, Income, Expenses
   - Total Debits = Total Credits
   - Balance Check ✓

2. **NEW: Tax Computation Schedule**
   - Profit per Accounts (before tax)
   - Tax Adjustments:
     - Add: Dividend Income (exempt)
     - Add: Capital Gains (separate regime)
   - Non-Trading Income (Taxable):
     - Interest Received
     - Less: Management Expenses (IBKR)
     - Less: Management Expenses (Other)
     - Less: Interest Paid (allowable)
   - Taxable Non-Trading Profit
   - Capital Gains (Section 104):
     - Total Gains
     - Total Losses
     - Less: SSE Relief (not applicable)
   - Taxable Capital Gains
   - **Total Taxable Profit (CT600)**

3. **NEW: Interest Relief Schedule**
   - Interest Paid (Account 5600)
   - Interest Coverage Ratio (ICR) Calculation:
     - Taxable Earnings (EBITDA proxy)
     - ICR Limit (30% of taxable earnings)
   - Allowable Interest Deduction
   - Disallowed Interest (carry forward)

4. **NEW: Corporation Tax Liability**
   - Taxable Profit
   - Tax Rate
   - **Corporation Tax Due**
   - Payment deadline (9 months after accounting period end)

5. **NEW: Section 104 Pooling Schedule**
   - Per symbol breakdown:
     - Acquisitions (Qty)
     - Disposals (Qty)
     - Pooled Cost (£)
     - Gain/(Loss) (£)
     - Remaining (Qty)

6. **Existing: Holdings Schedule** (unchanged but note added)
   - Lists open positions (STK, OPT only)
   - Note: Uses FIFO cost for FRS 105; Section 104 cost differs for tax

7. **NEW: Tax Shield Summary**
   - Lists all available reliefs:
     - Dividend Exemption: ✓ Applied (amount, tax saved)
     - SSE: ✗ Not Applicable (user confirmed)
     - Management Expense Relief: ✓ Applied (amount, tax saved)
     - Interest Relief (ICR-restricted): ⚠ Partial (amount, tax saved)
   - **Total Tax Saved from Shields**

8. **NEW: CT600 Box Mapping**
   - Box 13: Non-trading profits
   - Box 16: Chargeable gains
   - Box 46: Taxable total profit
   - Box 500: Corporation Tax chargeable

9. **NEW: Variance Analysis**
   - FIFO vs Section 104 comparison
   - IBKR vs Trial Balance comparison
   - Reasons for variances

10. **Existing: Metadata Footer** (enhanced)
    - Generated using HMRC monthly exchange rates
    - FRS 105 historical cost basis
    - FIFO cost method (financial statements)
    - Section 104 pooling (tax computation)

---

## User Confirmations

### Questions Asked and Answered

1. **SSE Eligibility**: Do any of your IBKR holdings qualify for Substantial Shareholding Exemption?
   - **User Answer**: No - all holdings are US-listed securities <10%
   - **Impact**: Capital gains will be taxable at 19-25% Corporation Tax rate

2. **Management Expenses**: Beyond IBKR fees, do you have other investment management expenses?
   - **User Answer**: Yes - has additional expenses
   - **Impact**: Tool must accept CSV file with additional expenses via `--management-expenses` parameter
   - **Format**: CSV with columns: description, amount_gbp, date

3. **Borrowing**: Has CAESARIS DENARII LIMITED borrowed money to finance investments?
   - **User Answer**: Yes - company has loans
   - **Impact**: Must apply Interest Coverage Ratio (ICR) restriction to interest relief
   - **ICR Rule**: Interest deduction limited to 30% of taxable earnings

4. **Report Format**: What format do you prefer?
   - **User Answer**: Single HTML file with all sections
   - **Impact**: All new sections integrated into single comprehensive HTML report

### Remaining Assumptions

- **First year**: No prior year losses to carry forward (assumed)
- **Accountant filing**: User will provide report to accountant for CT600 iXBRL filing

### Additional Management Expenses Implementation

User will need to create CSV file if they have additional expenses beyond IBKR fees:

**Format**: `analysis/management_expenses.csv`
```csv
description,amount_gbp,date
Accountant fees,2500.00,2025-12-31
Tax advisor fees,1500.00,2026-01-15
Bloomberg subscription,800.00,2025-06-30
```

**Usage**:
```bash
python scripts/ibkr_trial_balance.py analysis/business.csv \
    --period-end 2026-02-28 \
    --company "CAESARIS DENARII LIMITED" \
    --management-expenses analysis/management_expenses.csv \
    --output analysis/16235546_trial_balance_with_tax.html
```

---

## Implementation Plan

### Phase 1: Section 104 Pooling Module

**File**: `scripts/section_104_pooling.py` (~300 lines)

**Implementation Steps**:
1. Create `Section104Pool` class with pools dictionary and pending queues
2. Implement same-day matching logic in `add_acquisition()` and `remove_disposal()`
3. Implement 30-day matching logic (requires two-pass processing or rolling window)
4. Implement `remove_disposal()` method with matching rules priority:
   - Same-day acquisitions first
   - 30-day acquisitions second (if within window)
   - Section 104 pool third
5. Add `_move_expired_acquisitions_to_pool()` to handle 30-day window expiry
6. Add `get_pool_summary()` for current holdings
7. Add `get_disposal_summary()` for all disposals with gains/losses
8. Create `PoolTransaction` dataclass for individual transactions
9. Add error handling for edge cases:
   - FIFO failure scenarios (selling with no lots) - log warning, use zero cost
   - Negative pool quantities - raise error
   - Division by zero in average cost calculation
   - Options vs shares treatment (document assumption)

**Testing**:
- Validate same-day matching with test cases
- Validate 30-day matching with test cases
- Validate Section 104 pooling with test cases
- Test edge cases: negative pools, zero quantities, division by zero
- Validate against HMRC Section 104 examples
- Compare with FIFO results from current tool
- Document variances between FIFO and Section 104

### Phase 2: Tax Computation Module

**File**: `scripts/tax_computation.py` (~500 lines)

**Implementation Steps**:
1. Create `TaxComputation` class with trial balance and Section 104 inputs
2. Implement `calculate_dividend_exemption()` - Extract from account 4000
3. Implement `calculate_capital_gains()` - From Section 104 disposal summary
4. Implement `calculate_management_expenses()` - IBKR fees + load additional CSV
5. Implement `calculate_interest_relief()` - Apply ICR restriction
6. Implement `calculate_taxable_profit()` - Main tax computation logic
7. Implement `calculate_corporation_tax()` - Apply rates (19%/25% with taper)
8. Implement `generate_ct600_mapping()` - Map to boxes 13, 16, 46, 500
9. Create `TaxAdjustment` dataclass for individual adjustments
10. Add CSV parser for additional management expenses

**Testing**:
- Validate tax rate calculation for different profit levels (£0-£50k, £50k-£250k, £250k+)
- Verify marginal relief calculation (3/200 fraction)
- Verify dividend exemption extraction
- Compare Section 104 gains with FIFO gains
- Test ICR restriction with various scenarios (with warning that ICR may not apply)
- Test edge cases: negative taxable earnings, zero interest paid

### Phase 3: Integration with Trial Balance

**File**: `scripts/ibkr_trial_balance.py` (~100 lines added)

**Implementation Steps**:
1. Import new modules at top
2. Add command-line parameters:
   - `--management-expenses` (optional CSV file)
3. In `TrialBalanceGenerator.__init__()`, initialize `self.section_104 = None`
4. In `TrialBalanceGenerator.process()`:
   - Create `Section104Pool()` instance before trade processing
   - Process trades in chronological order (already sorted)
   - For each trade, call both `_process_trade()` (FIFO) and `_process_trade_section_104()` (Section 104)
   - After all trades processed, call `section_104._move_expired_acquisitions_to_pool()` to finalize pools
5. Add new method `_process_trade_section_104()`:
   - Extract cost in GBP (same conversion as FIFO)
   - If buy: call `section_104.add_acquisition(date, symbol, qty, cost_gbp)`
   - If sell: 
     - Calculate proceeds in GBP (net proceeds = gross - commission)
     - Call `section_104.remove_disposal(date, symbol, qty, proceeds_gbp)`
     - Gain/loss already recorded in disposal summary
   - Handle asset class filtering (STK, OPT only for Section 104; CASH/CRYPTO excluded)
6. In `main()`:
   - After `generator.process()`, create `TaxComputation` instance
   - Calculate taxable profit and tax liability
   - Pass both `generator` and `tax_comp` to `generate_html_report()`

### Phase 4: Enhanced HTML Report

**File**: `scripts/ibkr_trial_balance.py` (function `generate_html_report()`)

**Implementation Steps** (~300 lines added):
1. Update function signature: `generate_html_report(generator, tax_comp, company_name, period_end)`
2. After existing trial balance section, add:
   - Tax Computation Schedule (HTML table)
   - Interest Relief Schedule (HTML table)
   - Corporation Tax Liability (HTML table)
   - Section 104 Pooling Schedule (HTML table)
   - Tax Shield Summary (HTML table)
   - CT600 Box Mapping (HTML table)
   - Variance Analysis (HTML table)
3. Extract data from `tax_comp` object for template variables
4. Apply same CSS styling as existing sections
5. Add explanatory notes in `<div class="meta">` sections

### Phase 5: Documentation Updates

**Files to update**:
1. `README.md` - Add Tax Computation section
2. `docs/ADR-001-trial-balance.md` - Add Decision 8: Tax Computation Enhancement
3. `docs/discussions/8_tax_computation_enhancement_plan.md` - Update with final implementation

### Phase 6: Validation

**File**: `analysis/validate_tax_computation.py` (~200 lines)

**Implementation Steps**:
1. Load same data files as main tool
2. Run trial balance generator
3. Run tax computation
4. Validate:
   - Section 104 pool balances reasonable
   - Capital gains match disposals
   - Tax computation balanced
   - Dividend exemption = Account 4000
   - Interest relief ICR correctly applied
   - Management expenses include IBKR + additional
   - CT600 boxes populated
5. Print validation results with pass/fail

---

## Current Status

### Completed
- ✓ Full research on HMRC reconciliation requirements
- ✓ User questions asked and answered
- ✓ Complete implementation plan created
- ✓ Plan approved by user
- ✓ Todo list created
- ✓ **Phase 1: Section 104 Pooling Module** (2026-01-30)
- ✓ **Phase 2: Tax Computation Module** (2026-01-30)

### In Progress
- (none)

### Pending
- (none)

### Completed (Phases 3–6, 2026-01-30)
- ✓ **Phase 3: Integration** – Section 104 and TaxComputation wired in `ibkr_trial_balance.py`; `--management-expenses` CLI; STK/OPT fed to Section 104; `flush_all_pending()` after trades.
- ✓ **Phase 4: Enhanced HTML Report** – Tax Computation Schedule, Interest Relief (ICR), Corporation Tax Liability, Tax Shield Summary, Section 104 Disposals, CT600 Box Mapping, FIFO vs Section 104 variance; meta footer updated.
- ✓ **Phase 5: Documentation** – ADR-001 Decision 8 added; README updated (output, arguments, file structure, limitation 2).
- ✓ **Phase 6: Validation** – `analysis/validate_tax_computation.py` created; 6 checks (Section 104 sum, dividend exemption, taxable profit, CT sign, CT600 box 46/500).

---

## Next Steps

### Phase 1 Implementation Notes (2026-01-30)

**Created** `scripts/section_104_pooling.py`:
- `Section104Pool`: main engine with same-day and 30-day matching
- `DisposalRecord`: pending disposal (unmatched portion)
- `MatchedDisposal`: completed disposal with cost, proceeds, gain/loss, matching_rule
- `PoolSummary`: current pool position per symbol
- **Flow**: Disposals are queued; acquisitions match against pending (same-day then 30-day); remainder of acquisition goes to Section 104 pool. When a disposal is 30+ days old it is flushed (unmatched portion taken from pool). Call `flush_all_pending()` after all trades.
- **Tests**: `_test_section_104_only`, `_test_same_day_matching`, `_test_thirty_day_matching` (run with `python scripts/section_104_pooling.py`)

### Phase 2 Implementation Notes (2026-01-30)

**Created** `scripts/tax_computation.py`:
- `TaxComputation(generator, section_104_pool, management_expenses_path=None)`: consumes trial balance `.accounts` and Section 104 pool.
- `TaxAdjustment`, `InterestReliefResult`, `CT600Mapping` dataclasses.
- **Methods**: `calculate_dividend_exemption()`, `calculate_capital_gains()`, `calculate_management_expenses()` (IBKR 5200 + optional CSV), `calculate_interest_relief()` (ICR 30%), `calculate_taxable_profit()`, `calculate_corporation_tax()` (19%/25%/marginal 3/200), `generate_ct600_mapping()`.
- **CSV**: Optional `--management-expenses` CSV with columns `description`, `amount_gbp`, `date`.
- **Test**: `_test_tax_computation()` with mock accounts and Section 104 pool (run with `python scripts/tax_computation.py`).

### Immediate (Phase 3)

1. **Integrate** in `ibkr_trial_balance.py`: import Section 104 and TaxComputation; run Section 104 in parallel with FIFO; after `process()`, call `flush_all_pending()`, create `TaxComputation(generator, section_104, management_expenses_path)`, compute taxable profit and CT; pass generator + tax_comp to HTML report (Phase 4).
2. **Add** `--management-expenses` CLI argument (optional CSV path).
3. **Proceed to Phase 4**: Enhanced HTML report.

### Expected Timeline

- **Phase 1**: 4-5 hours (Section 104 pooling with same-day/30-day matching)
- **Phase 2**: 5-6 hours (Tax computation with edge cases)
- **Phase 3**: 1-2 hours (Integration with dual tracking)
- **Phase 4**: 4 hours (HTML report)
- **Phase 5**: 1 hour (Documentation)
- **Phase 6**: 2 hours (Validation with comprehensive tests)
- **Testing**: 2-3 hours (End-to-end with edge cases)

**Total**: 19-23 hours

**Note**: Timeline increased due to complexity of same-day/30-day matching rules and edge case handling.

---

## Critical Files Reference

### Files to Create
1. `scripts/section_104_pooling.py` - Section 104 pooling engine
2. `scripts/tax_computation.py` - Tax computation engine
3. `analysis/validate_tax_computation.py` - Validation script
4. `analysis/management_expenses.csv` - User's additional expenses (user creates)

### Files to Modify
1. `scripts/ibkr_trial_balance.py` - Integration + HTML report enhancement
2. `README.md` - Documentation update
3. `docs/ADR-001-trial-balance.md` - Architectural decision

### Files Created During Planning
1. `docs/discussions/8_tax_computation_enhancement_plan.md` - Implementation plan
2. `docs/discussions/8_tax_computation_enhancement_complete_spec.md` - This document

---

## Verification Checklist

### When Implementation Complete

- [ ] Section 104 pooling implements same-day matching correctly
- [ ] Section 104 pooling implements 30-day matching correctly
- [ ] Section 104 pooling calculates average cost correctly
- [ ] Capital gains match Section 104 disposals
- [ ] Dividend exemption correctly identified (Account 4000)
- [ ] Interest relief ICR restriction applied correctly (with warning that ICR may not apply to investment companies)
- [ ] Management expenses include IBKR + additional CSV
- [ ] Tax computation shows profit to taxable profit reconciliation
- [ ] Corporation Tax liability calculated correctly (including marginal relief for £50k-£250k band)
- [ ] HTML report includes all 9 new sections
- [ ] Variance analysis explains FIFO vs Section 104 difference
- [ ] CT600 box mapping provided (boxes 13, 16, 46, 500)
- [ ] Documentation updated (README, ADR-001)
- [ ] Validation script runs successfully
- [ ] End-to-end test produces correct HTML output

---

## Key References

### External Resources
- [HMRC Company Tax Return CT600 Guide 2026](https://datatracks.com/uk/blog/hmrc-company-tax-return-ct600-guide/)
- [Section 104 Share Pooling - HMRC Manual CG51620](https://www.gov.uk/hmrc-internal-manuals/capital-gains-manual/cg51620)
- [FRS 105 Overview Paper - Tax Implications](https://www.gov.uk/government/publications/accounting-standards-the-uk-tax-implications-of-new-uk-gaap/frs-105-overview-paper-tax-implications)
- [Substantial Shareholding Exemption (SSE) - Pinsent Masons](https://www.pinsentmasons.com/out-law/guides/the-substantial-shareholding-exemption)
- [Corporation Tax Treatment of Interest - HMRC Manual](https://www.gov.uk/hmrc-internal-manuals/corporate-finance-manual/cfm35310)

### Internal Documents
- `README.md` - Project overview
- `docs/ADR-001-trial-balance.md` - Architectural decisions
- `docs/VALIDATION_REPORT_2026-01-30.md` - Current tool validation
- `docs/discussions/0-7*.md` - Historical development decisions

---

## Contact Information

**Project**: ibkr-hmrc movements monitoring system
**Company**: CAESARIS DENARII LIMITED (Company No. 16235546)
**Accounting Year End**: 28 February
**Accounting Framework**: FRS 105 (Micro-entities)
**Database**: ClickHouse (ibkr-hmrc)

---

*This document is complete and self-contained. Any Claude instance can read this and continue implementation from the current status.*
